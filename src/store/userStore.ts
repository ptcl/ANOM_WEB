import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import axios from 'axios'
import { IAgent } from '@/types/agent'

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL

interface AgentState {
    isAuthenticated: boolean;
    agent: IAgent | null;
    isLoading: boolean; // ‚úÖ Ajout du loading dans le store

    getProfile: () => Promise<IAgent | null>;
    verifyAuthentication: () => Promise<boolean>;
    refreshAuthentication: () => Promise<boolean>;
    initializeAuth: () => Promise<boolean>; // ‚úÖ Nouvelle m√©thode unifi√©e
    logout: () => void;
    setAgent: (agent: IAgent | null) => void;
    updateAgent: (updates: Partial<IAgent>) => void;
    updateSettings: (updates: Partial<IAgent['protocol']['settings']>) => void;
    updateProtocolLocal: (updates: Partial<IAgent['protocol']>) => void;
    updateProtocol: (updates: Partial<IAgent['protocol']>) => Promise<{ success: boolean; error?: string }>;
    getAgentProgress: () => Promise<unknown | null>;
    getAvailableChallenges: () => Promise<unknown | null>;
    getAgentAllContracts: () => Promise<unknown[] | null>;
}

export const useUserStore = create<AgentState>()(
    persist(
        (set, get) => ({
            isAuthenticated: false,
            agent: null,
            isLoading: true, // ‚úÖ √âtat de chargement initial

            // ‚úÖ M√âTHODE PRINCIPALE - √Ä utiliser dans vos pages
            initializeAuth: async () => {
                try {
                    // console.log('üöÄ Initialisation de l\'authentification...');
                    set({ isLoading: true });

                    const tempToken = sessionStorage.getItem('temp_auth_token');

                    if (!tempToken) {
                        // console.log('‚ùå Pas de token, utilisateur non connect√©');
                        set({
                            isAuthenticated: false,
                            agent: null,
                            isLoading: false
                        });
                        return false;
                    }

                    console.log('üîë Token trouv√©, v√©rification...');
                    console.log(tempToken);
                    // Essai de r√©cup√©ration du profil complet
                    const agent = await get().getProfile();

                    if (agent) {
                        // console.log('‚úÖ Profil r√©cup√©r√© avec succ√®s:', agent.protocol?.agentName);
                        set({
                            isAuthenticated: true,
                            agent,
                            isLoading: false
                        });
                        return true;
                    } else {
                        // Fallback: v√©rification simple du token
                        console.log('‚ö†Ô∏è √âchec r√©cup√©ration profil, v√©rification token...');
                        const isValid = await get().verifyAuthentication();
                        set({ isLoading: false });
                        return isValid;
                    }

                } catch (error) {
                    console.error('‚ùå Erreur initialisation auth:', error);
                    set({
                        isAuthenticated: false,
                        agent: null,
                        isLoading: false
                    });
                    return false;
                }
            },

            verifyAuthentication: async () => {
                try {
                    const tempToken = sessionStorage.getItem('temp_auth_token')

                    if (!tempToken) {
                        set({ isAuthenticated: false })
                        return false
                    }

                    console.log('üîç V√©rification du token...');

                    const response = await axios.post(`${API_BASE_URL}/api/identity/verify`,
                        { token: tempToken },
                        {
                            headers: {
                                'Content-Type': 'application/json',
                                'ngrok-skip-browser-warning': 'true'
                            }
                        }
                    )

                    const { success, data } = response.data
                    if (success && data.valid) {
                        console.log('‚úÖ Token valide');
                        set({
                            isAuthenticated: true,
                            agent: data.agent || get().agent // Garde l'agent existant si pas dans la r√©ponse
                        })
                        return true
                    } else {
                        console.log('üîÑ Token invalide, tentative de refresh...');
                        return await get().refreshAuthentication()
                    }
                } catch (error) {
                    console.error('‚ùå Erreur v√©rification token:', error)
                    set({ isAuthenticated: false })
                    return false
                }
            },

            refreshAuthentication: async () => {
                try {
                    const tempToken = sessionStorage.getItem('temp_auth_token')

                    if (!tempToken) {
                        set({ isAuthenticated: false })
                        return false
                    }

                    console.log('üîÑ Refresh du token...');

                    const response = await axios.post(`${API_BASE_URL}/api/identity/refresh`,
                        { token: tempToken },
                        {
                            headers: {
                                'Content-Type': 'application/json',
                                'ngrok-skip-browser-warning': 'true'
                            }
                        }
                    )

                    const { success, data } = response.data

                    if (success) {
                        console.log('‚úÖ Token refresh√©');
                        sessionStorage.setItem('temp_auth_token', data.token)

                        set({
                            isAuthenticated: true,
                            agent: data.agent || get().agent
                        })
                        return true
                    } else {
                        console.log('‚ùå √âchec refresh token');
                        set({ isAuthenticated: false })
                        return false
                    }
                } catch (error) {
                    console.error('‚ùå Erreur refresh token:', error)
                    set({ isAuthenticated: false })
                    return false
                }
            },

            getProfile: async () => {
                try {
                    const tempToken = sessionStorage.getItem('temp_auth_token')
                    if (!tempToken) {
                        console.log('‚ùå getProfile: Pas de token');
                        return null;
                    }

                    console.log('üì° R√©cup√©ration du profil...');

                    const response = await axios.get(`${API_BASE_URL}/api/protocol/agent/profile`, {
                        headers: {
                            'Authorization': `Bearer ${tempToken}`,
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        }
                    })

                    console.log('üì• R√©ponse getProfile:', response.status, response.data);

                    const { success, data } = response.data

                    if (success && data?.agent) {
                        console.log('‚úÖ Profil r√©cup√©r√©:', data.agent.protocol?.agentName);
                        set({ agent: data.agent })
                        return data.agent
                    } else {
                        console.log('‚ö†Ô∏è R√©ponse sans agent valide:', { success, hasData: !!data, hasAgent: !!data?.agent });
                        return null
                    }
                } catch (error) {
                    console.error('‚ùå Erreur getProfile:', error)

                    if (axios.isAxiosError(error)) {
                        console.error('üìä D√©tails erreur API:', {
                            status: error.response?.status,
                            statusText: error.response?.statusText,
                            data: error.response?.data
                        });
                    }

                    return null
                }
            },

            logout: () => {
                console.log('üëã D√©connexion...');
                sessionStorage.removeItem('temp_auth_token')

                set({
                    isAuthenticated: false,
                    agent: null,
                    isLoading: false
                })
            },

            setAgent: (agent) => {
                console.log('üìù setAgent:', agent?.protocol?.agentName);
                set({ agent });
            },

            updateAgent: async (updates: Partial<IAgent['protocol']>) => {
                const currentAgent = get().agent;

                if (!currentAgent?.bungieUser || !currentAgent?.protocol) {
                    return { success: false, error: 'Structure agent invalide' };
                }

                try {
                    // 1. Update optimiste
                    get().updateProtocolLocal(updates);

                    // 2. Appel API pour sauvegarde seulement
                    const tempToken = sessionStorage.getItem('temp_auth_token');
                    const response = await axios.patch(
                        `${API_BASE_URL}/api/protocol/agent/profile`,
                        { protocol: updates },
                        {
                            headers: {
                                'Authorization': `Bearer ${tempToken}`,
                                'Content-Type': 'application/json',
                                'ngrok-skip-browser-warning': 'true'
                            }
                        }
                    );

                    if (!response.data.success) {
                        throw new Error(response.data.message || '√âchec API');
                    }

                    console.log('‚úÖ Sauvegarde API r√©ussie');

                    // 3. ‚úÖ PAS de sync - l'update optimiste suffit
                    // L'API confirme juste que c'est sauv√© en BDD

                    return { success: true };

                } catch (error) {
                    console.error('‚ùå Erreur API, rollback:', error);
                    set({ agent: currentAgent });
                    return { success: false, error: error instanceof Error ? error.message : String(error) };
                }
            },
            updateProtocolLocal: (updates) => set((state) => {
                console.log('üîÑ updateProtocolLocal:', updates);

                if (!state.agent?.bungieUser || !state.agent?.protocol) {
                    console.error('‚ùå Structure agent invalide');
                    return state;
                }

                const result = {
                    agent: {
                        ...state.agent,
                        protocol: {
                            ...state.agent.protocol,
                            ...updates
                        }
                    }
                };

                console.log('‚úÖ updateProtocolLocal termin√©');
                return result;
            }),
            updateProtocol: async (updates) => {
                const currentAgent = get().agent;

                if (!currentAgent?.bungieUser || !currentAgent?.protocol) {
                    console.error('‚ùå updateProtocol: Structure agent invalide');
                    return { success: false, error: 'Structure agent invalide' };
                }

                console.log('üöÄ updateProtocol avec API:', updates);

                try {
                    // 1. ‚úÖ Mise √† jour optimiste (UI imm√©diate)
                    console.log('‚ö° Update optimiste...');
                    get().updateProtocolLocal(updates);

                    // 2. ‚úÖ Appel API
                    const tempToken = sessionStorage.getItem('temp_auth_token');
                    if (!tempToken) {
                        throw new Error('Token d\'authentification manquant');
                    }

                    console.log('üì° Appel API...');
                    const response = await axios.patch(
                        `${API_BASE_URL}/api/protocol/agent/profile`,
                        {
                            protocol: updates
                        },
                        {
                            headers: {
                                'Authorization': `Bearer ${tempToken}`,
                                'Content-Type': 'application/json',
                                'ngrok-skip-browser-warning': 'true'
                            }
                        }
                    );

                    if (!response.data.success) {
                        throw new Error(response.data.message || '√âchec de la mise √† jour c√¥t√© serveur');
                    }

                    console.log('‚úÖ API mise √† jour avec succ√®s');

                    // 3. ‚úÖ Synchroniser avec la r√©ponse serveur (optionnel)
                    if (response.data.data?.agent) {
                        console.log('üîÑ Synchronisation avec la r√©ponse serveur...');
                        set({ agent: response.data.data.agent });
                    }

                    return { success: true };

                } catch (error) {
                    console.error('‚ùå Erreur updateProtocol:', error);

                    // 4. ‚úÖ Rollback automatique
                    console.log('‚Ü©Ô∏è Rollback en cours...');
                    set({ agent: currentAgent });

                    const errorMessage = error instanceof Error ? error.message : 'Erreur inconnue';
                    return { success: false, error: errorMessage };
                }
            },

            updateSettings: (updates) => set((state) => {
                if (!state.agent) return { agent: null };

                console.log('üîÑ updateSettings:', updates);
                return {
                    agent: {
                        ...state.agent,
                        protocol: {
                            ...state.agent.protocol,
                            settings: {
                                ...state.agent.protocol.settings,
                                ...updates
                            }
                        }
                    }
                };
            }),


            getAgentProgress: async () => {
                try {
                    const tempToken = sessionStorage.getItem('temp_auth_token');
                    if (!tempToken) {
                        console.log('‚ùå getAgentProgress: Pas de token');
                        return null;
                    }

                    console.log('üì° R√©cup√©ration de la progression des challenges...');

                    const response = await axios.get(`${API_BASE_URL}/api/protocol/agent/challenge/progress`, {
                        headers: {
                            'Authorization': `Bearer ${tempToken}`,
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });

                    console.log('üì• R√©ponse getAgentProgress:', response.status, response.data);

                    const { success, data } = response.data;
                    console.log('üìä Donn√©es de progression:', data);

                    if (success) {
                        return data;
                    } else {
                        console.log('‚ö†Ô∏è R√©ponse sans data valide:', { success, data });
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå Erreur getAgentProgress:', error);

                    if (axios.isAxiosError(error)) {
                        console.error('üìä D√©tails erreur API:', {
                            status: error.response?.status,
                            statusText: error.response?.statusText,
                            data: error.response?.data
                        });
                    }

                    return null;
                }
            },

            getAvailableChallenges: async () => {
                try {
                    const tempToken = sessionStorage.getItem('temp_auth_token');
                    if (!tempToken) {
                        console.log('‚ùå getAvailableChallenges: Pas de token');
                        return null;
                    }
                    const response = await axios.get(`${API_BASE_URL}/api/protocol/challenges/available`, {
                        headers: {
                            'Authorization': `Bearer ${tempToken}`,
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                    const { success, data } = response.data;

                    if (success) {
                        return response.data;
                    } else {
                        console.log('‚ö†Ô∏è R√©ponse sans data valide:', { success, data });
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå Erreur getAllChallenge:', error);

                    if (axios.isAxiosError(error)) {
                        console.error('üìä D√©tails erreur API:', {
                            status: error.response?.status,
                            statusText: error.response?.statusText,
                            data: error.response?.data
                        });
                    }

                    return null;
                }
            },

            getAgentAllContracts: async () => {
                try {
                    const tempToken = sessionStorage.getItem('temp_auth_token');
                    if (!tempToken) {
                        console.log('‚ùå getAgentAllContracts: Pas de token');
                        return null;
                    }
                    // R√©cup√©ration de l'agentId depuis le store
                    const agentId = get().agent?.bungieId;
                    if (!agentId) {
                        console.log('‚ùå getAgentAllContracts: Pas d\'agentId');
                        return null;
                    }
                    const response = await axios.get(`${API_BASE_URL}/api/protocol/agent/contracts`, {
                        headers: {
                            'Authorization': `Bearer ${tempToken}`,
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        }
                    });
                    console.log('üì• R√©ponse getAgentAllContracts:', response.status, response.data);
                    if (Array.isArray(response.data)) {
                        return response.data;
                    } else {
                        console.log('‚ö†Ô∏è R√©ponse inattendue:', response.data);
                        return null;
                    }
                } catch (error) {
                    console.error('‚ùå Erreur getAgentAllContracts:', error);
                    if (axios.isAxiosError(error)) {
                        console.error('üìä D√©tails erreur API:', {
                            status: error.response?.status,
                            statusText: error.response?.statusText,
                            data: error.response?.data
                        });
                    }
                    return null;
                }
            },

        }),
        {
            name: 'anom-user-data',
            partialize: (state) => ({
                agent: state.agent,
                isAuthenticated: state.isAuthenticated
            })
        }
    )
)